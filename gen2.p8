pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
c_x=0
c_y=0

function _init()
	read_map()
	reset_level()
	get_new_level()
	update_map()
end

function _draw()
	cls()
	camera(c_x,c_y)
	m_x=flr(c_x/8)-1
	m_y=flr(c_y/8)-1
	map(m_x,m_y,m_x*8,m_y*8,18,18)
	//spr(3,p_x,p_y)
	//spr(4,p_x+4,p_y+7)
end

function _update()
	if (btn(1)) c_x+=1
	if (btn(0)) c_x-=1
	if (btn(2)) c_y-=1
	if (btn(3)) c_y+=1
end

-- helpers

function rand(bot,top)
	return flr(rnd(top))+bot
end

function chance(n)
	return rand(0,100) < n
end

-- map read/update

function map_sect(sx,ex,sy,ey)
	local t={}
	for y=sy,ey do
		for x=sx,ex do
			local q={}
			for j=0,7 do
				q[j]={}
				for i=0,7 do
					q[j][i]=mget(i+(x*8),j+(y*8))
				end
			end
			add(t,q)
		end
	end
	return t
end

function read_map()
	type_1=map_sect(0,1,0,0)
	type_2=map_sect(0,1,1,1)
	type_0=map_sect(15,15,7,7)
end

function update_map()
	for j=0,ymax-1 do
		for i=0,xmax-1 do
			if (level[j][i]==0) q=type_0[1]
			if (level[j][i]==1) q=type_1[rand(1,2)]
			if (level[j][i]==2) q=type_2[rand(1,2)]
			for y=0,7 do
				for x=0,7 do
					mset((i*8)+x,(j*8)+y,q[y][x])
				end
			end
		end
	end
end

-- level generation

function reset_level()
	level={}
	xmax=16
	ymax=8
	for j=0,ymax-1 do
		level[j]={}
		for i=0,xmax-1 do
			level[j][i]=0
		end
	end
end

function get_new_level()
	reset_level()
	if chance(100) then
		//printh('type 1')
		for x=0,5 do
			generate_level()
		end
	else
		//printh('tupe 2')
		generate_level()
		add_noise()
	end
	print_level()
end

function generate_level()
	local i=rand(0,xmax-1)
	local j=0
	local last_j=0
	local d=get_d()
	while j<ymax do
		if i<0 or i>=xmax then
			i-=d
			level[j][i]=2
			d+=-1
			last_j=j
			j+=1
		elseif chance(20) or level[j][i] != 0 then
			level[j][i]=2
			last_j=j
			j+=1
			d=get_d()
		else
			if last_j != j then
				last_j=j
				level[j][i]=2
			elseif level[j][i]==0 then
				level[j][i]=1
			end
			i+=d
		end
	end
end

function get_d()
	if (chance(50)) return 1
	return -1
end

function add_noise()
	for x=0,100 do
		local rj=rand(1,ymax-1)
		local ri=rand(1,xmax-1)
		if level[rj][ri]==0 then
			if chance(50) then
				level[rj][ri]=1
			else
				level[rj][ri]=2
			end
		elseif (level[rj-1][ri]==2 or level[rj-1][ri]==2) and chance(30) then
			level[rj][ri]=2
		end
	end
end

function print_level()
	for j=0,ymax-1 do
		local s=''
		for i=0,xmax-1 do
			s=s..level[j][i]
		end
		printh(s)
	end
	printh('')
end
__gfx__
000000000bb31bb300b31bb30bb31bb30bb31bb30bb31bb30bb31300000000000650065000003000000000000000000000000000000000000000000000000000
00000000bb30b30b0330b30bbb30b30bbb30b30bbb30b30bbb30bb30000000004444444200003000000000000000000000000000000000000000000000000000
00700700b1bb0bb3bb0b0bb3b1bb0bb3b1bb0bb3b1bb0bb3b1bb0bb30000000042222222000b0000000000000000000000000000000000000000000000000000
0007700045054b04b0b54b0445333b044b3b4b334b3b4b334505330b000000000650065003030000000000000000000000000000000000000000000000000000
00077000544402443b41024454431b445333023b5333023b54440333000000000650065000303000000000000000000000000000000000000000000000000000
00700700420454204b0454204204b32042b451104bbb5110420454bb0000000044444442000030300030000000000000fff00000000000000000000000000000
0000000054404504544045045440b504543145345b3b4b3b544045040000000042222222000b030000300300090008000f000fff00fff0000000000000000000
0000000025004040250040402500404025b040402bb040bb2500404000000000065006500003000030300330090088800f0000f0000f00000000000000000000
11521212445212424452124200000000000000000b0b003b4b0b043b000000000000000000000000000000000000000000000000000000000000000000000000
101011154040440540404405000000000000000000b0003320b44433000000000000000000cc00cc000000000000000000000000000000000000000000000000
111105514144055441440554000000000000000000b3003042b304320000000000000000ccc1ccc1000000000000000000000000000000000000000000000000
150511014515440145154401000000000000000000030030140310300000000000000000c1c1c111000000000000000000000000000000000000000000000000
11010211110102144404021400000000000000000003000004430241000000000000000011111111000000000000000000000000000000000000000000000000
12005120120051201200542400000000000000000000000041104404000000000000000011111111000000000000000000000000000000000000000000000000
11101101411011010441140100000000000000000000000004441044000000000000000010110110000000000000000000000000000000000000000000000000
21001010210010102140404100000000000000000000000012040201000000000000000001111011000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
54400454544004544040045430400b54000440000003400000000000000000000000000000000000000000000000000000000000000000000000000000000000
45400444454004444440044543400345000440000034400000000000000000000000000000000000000000000000000000000000000000000000000000000000
b1bb0bb3b1bb0bb30000000003000300000400000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000
353b4b0b153b4b0b04544440043444b0000450000003500000000000000000000000000000000000000000000000000000000000000000000000000000000000
340b024b204402450000000000300b00000440000004b00000000000000000000000000000000000000000000000000000000000000000000000000000000000
b2b454b04424544044400544444005b4000540000005430000000000000000000000000000000000000000000000000000000000000000000000000000000000
534045045340450445400044454000b4000440000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000
25004040250040400000000000000b00000440000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1111111111111111121212101011111110111111111111121203010101111110121111111010121210101010101010101204041212050512101110111011111010101010101010101211111111111112111111121212121211111111111111111010101010101010101010101010101010101010101010101111111011111110
1010101010101010101112001000101110100800000b00111200010000000c001210000000000c111000000000090010120800000b0015120000000000000c10000000000c0000101200000000000012000000001212110010100000101010101010101010101010000000000c0008100000000000000000000b00000b00000a
000000000900000900100000000000000000080203040103120000000103030011000006080201010000000000090000120803040500001211110c0000001110000010101000001011000d0206000011050600001111000010000000001010100010101010101000111111111111081002040101080005050305050306000005
0000000009000009000000000000000000000811111111110201010000000000100805000810111100000609000500001108111116030405000011111100101010081008000c10101000021111060010161100000000001100000000000000100000101010000000000008000000081000000000080015050015161108000015
000000000900000900000000000000000a0008000000090000090000030400000008120008000009000000010115000d0008000009001515000008000d000000000810081010000000000010100000001500000303060000000000100000000000000010100000000000080c0000080000020600080000150000110008020600
000d0d00090b0009000000020406000001030304000203060009090203120303060805030403050401060000000002050506000206000002101008101010001010081008000000101111000000001111100000000000001110001010000000101000000000000010100008111111081001121200080000001000100008151500
01010101010101010404011112120600111111020104111100090911121212111108150d150b15111212060000021216150a0009000002110c000800100000100d081008101010101000001010000d1000001000001112101010101010101010101000000010101000000800000008001011110008000305000000000800000a
1111111111111111101011101011110110101010111110101010101010111110100303030401031012111105031111101111110103031110101010101010101010101010101010101010101010101010101010111111111010101010101010101010101010101010101010101010101010101011111111161111111111011201
1111111111111111113232113233353300000000000000001111111111111112111111050433330500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000002400000202000000000000353500000000003232333200000000000012000000161500001500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000030600000000313533320000000034003200000008333211030600090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0032323308320000323233000508030600323308323232003332323208003410113332330033323300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0034003508000000003415001508000000350008000035003500000008003400000009350034090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0034003508000000003400000008000000350008000002050104000b08000203000009350034313100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0230313108310202003432323332000030300008303012161112110405061110313130313005111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111102323211111111323211113030111111121010101116111010111111111110101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
