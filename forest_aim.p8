pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
mode=0

anm_w={4,5,6,5,4,7,8,7}
anm_i={0,1,2,1}
anm_s={48,49,48,50}

pp={
	x=64,y=64,dx=1,dy=0,lpx=1,
	w=4,h=6,
	wt=0,it=0,at=0,
	mode=0,a_mode=0,
	hb=nil
}

hit_bs={
	{w=8,h=8,pwr=1},
	{w=8,h=8,pwr=2},
	{w=8,h=8,pwr=3},
}

enmy={} --enemies

-- helpers
function rand(bot,top)
	return flr(rnd((top+1)-bot))+bot
end

function col_bb(a,b)
	local ax=a.x-a.w/2
	local ay=a.y-a.h/2
	local bx=b.x-b.w/2
	local by=b.y-b.h/2
	return ax<=bx+b.w and
		ax+a.w>=bx and ay<=by+b.h and
		ay+a.h>=by
end

function _init()
	printh("==== start ====")
	for i=0,10 do
		add_enmy(rand(10,118),rand(10,118))
	end
end

function _draw()
	cls()
	if(mode==0)draw_game()
end

function _update()
	if(mode==0)update_game()
end

function draw_game()
	draw_player()
	// draw_bb(pp)
	if(pp.hb!=nil)draw_bb(pp.hb)
	draw_enmy()
end

function update_game()
	update_player()
	update_enmy()
end

function draw_bb(a)
	local ax=a.x-a.w/2
	local ay=a.y-a.h/2
	rect(ax,ay,ax+a.w,ay+a.h,8)
	pset(a.x,a.y,8)
end

function draw_player()
	if pp.mode==2 then
		draw_player_atk()
		return
	end
	
	local px=(pp.x-pp.w/2)-1
	local py=(pp.y-pp.h/2)-2
	local oy=0
	
	-- bottom half
	if pp.mode==1 then
		local s=anm_w[flr(pp.wt)+1]
		spr(s,px,py)
	else
		oy=anm_i[flr(pp.it)+1]
		spr(4,px,py)
	end
	
	draw_player_top(oy)
end

function draw_player_top(oy)
	local px=(pp.x-pp.w/2)-1
	local py=(pp.y-pp.h/2)-2
	
	if pp.dy==-1 then
		spr(3,px,py+oy)
	elseif pp.lpx==-1 then
		spr(2,px,py+oy)
	else
		spr(1,px,py+oy)
	end
end

function draw_player_atk()
	draw_player_top(0)
	
	local px=(pp.x-pp.w/2)-1
	local py=(pp.y-pp.h/2)-2
	spr(4,px,py)
	
	local fx=false
	local fy=false
	local start=16

	if pp.dx==1 then
		start=32
	elseif pp.dx==-1 then
		start=32
		fx=true
	elseif pp.dy==-1 then
		fy=true
	end
	
	if pp.a_mode==0 then
		local s=flr(pp.at)+start
		spr(s,
			px+pp.dx*4,py+pp.dy*4,
			1,1,fx,fy
		)
	elseif pp.a_mode==1 then
		local s=flr(pp.at)+start+4
		spr(s,
			px+pp.dx*4,py+pp.dy*4,
			1,1,fx,fy
		)
	elseif pp.a_mode==2 then
		local s=flr(pp.at)+start+9
		spr(s,
			px+pp.dx,py+pp.dy,
			1,1,fx,fy
		)
		if pp.at<3 then
			circ(px+4,py+4,6+pp.at,1)
		end
	end
end

function update_player()
	if pp.mode==2 then
		update_player_atk()
		return
	end
	
	local dx,dy=0,0
	
	if(btn(⬅️))dx=-1
	if(btn(➡️))dx=1
	if(btn(⬆️))dy=-1
	if(btn(⬇️))dy=1
	
	if dx!=0 then
		pp.lpx=dx
	end
	
	if dx!=0 or dy!=0 then
		pp.dx,pp.dy=dx,dy
		pp.x+=pp.dx
		pp.y+=pp.dy
		pp.mode=1
		pp.wt=(pp.wt+0.4)%7
		pp.it=0
	else
		pp.mode=0
		pp.wt=0
		pp.it=(pp.it+0.3)%4
	end
	
	-- attack
	if btnp(❎) and pp.mode!=2 then
		pp.mode=2
	end
end

function update_player_atk()
	pp.at=(pp.at+0.5)
	local hb=hit_bs[pp.a_mode+1]
	
	-- todo:
	-- dif hbs can have
	-- dif w,h,time, etc 
	if pp.at<2 then
		pp.hb={
			x=pp.x+pp.dx*2,
			y=pp.y+pp.dy*2,
			w=hb.w,
			h=hb.h
		}
		for e in all(enmy)do
			if col_bb(pp.hb,e) then
				del(enmy,e)
			end
		end
	else
		pp.hb=nil
	end
	
	if pp.a_mode==0 and pp.at>=4 then
		pp.at=0
		pp.mode=0
		pp.a_mode=1
	elseif pp.a_mode==1 and pp.at>=5 then
		pp.at=0
		pp.mode=0
		pp.a_mode=2
	elseif pp.a_mode==2 and pp.at>=6 then
		pp.at=0
		pp.mode=0
		pp.a_mode=0
	end
end

// function set_hitb()
// end

function add_enmy(x,y)
	add(enmy,{
		x=x,y=y,at=rand(0,3),
		w=8,h=6
	})
end

function draw_enmy()
	for e in all(enmy)do
		local ex=e.x-e.w/2
		local ey=(e.y-e.h/2)-1
		local s=anm_s[flr(e.at)+1]
		spr(s,ex,ey)
		// draw_bb(e)
	end
end

function update_enmy()
	for e in all(enmy)do
		e.at=(e.at+0.3)%4
	end
end


__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700007777000077770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000007777000077770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000007c7c0000c7c70000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700007777000077770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000007007000070070000700000007007000000070000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000007007000070000000700000000007000000070000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000008000000880000000000000800000008000000000000000bb000000b00bbb00000bbbbb0000bbbbb000bbbbb00000000
0c0000000000000000000000000000000080000088800000000000080000000800000008000000b0bb0000bb0bbb00000bbb000000b0000000b0000000000000
0cc000000000000c0000000000000000008000008880008000000080000000800000008000000b00bbb00bbbbbb00000bb0000000b0000000000000000000000
0cc000000c0000c0000000000000000000080000888800800800008000000080000000800000b000bbbbbbbbbb000000bb000000b00000000000000000000000
00c000000c0000c00c0000c0000000c0000800000888088008800880080000800000008000000000bbbbbbbbbb000000bb000000b00000000000000000000000
000c000000c0ccc000c00cc0000000c00000800008888880088888800800088000000880000000000bbbbbb00bb000b00b0000000b0000000000000000000000
0000000000cccc0000cccc0000000c000000000000888800008888000000080000000800000000000bbbbbb000bbbb0000b0000000b000000000000000000000
00000000000cc000000cc000000cc000000000000008800000088000000880000000000000000000000bb000000bb000000b0000000000000000000000000000
0000000000c0000000000000000000000000000000000000880000008800000008000000b0000000bbbbb0000000000000000000b0000000b000000000000000
00000000000ccc000000cc000000cc0000000000008888000088880000888800008888000b0000000bbbbbb000000b00b0000000b0000000b000000000000000
0000000000000cc000000cc0000000c0000000000000888000008880000008800000088000b0000000bbbbb0000000b0b0000000b0000000b000000000000000
0000000000000ccc000000cc0000000c0000080000000888000008880000000800000000000b0000000bbbbbb00000bbb0000000b0000000b000000000000000
00000c00000000cc000000cc0000000c000880000008888800000888000000080000000000000000000bbbbbbb0000bbbb00000bb0000000b000000000000000
00ccc00000000cc000000cc00000000008800000088888800000888000000000000000000000000000bbbbb0bbb00bb0bb0000b00b0000b00b00000000000000
0ccc0000000cc0000000c000000000008000000088888800000888000000880000000000000000000bbbbbb00bbbbb000bbbbb0000b00b000000000000000000
00000000000000000000000000000000000000008888000000000000000000000000000000000000bbbbb00000bbb00000bbb000000bb0000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000bbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000bb0000b3333b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00b33b000b7337b000bbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0b3333b0b373373b0b3333b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b373373bb333333bb333333b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b171171bb311113bb771177b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbbb00bbbbbb00bbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
