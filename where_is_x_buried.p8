pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
px,py=64,64

function _init()
	init_lvl(0,0)
end

mode=-1
function _draw()
	cls()
	for o in all(lvl) do
		local i=flr(o.x/8)
		local j=flr(o.y/8)
		if sb[j][i]==1 then
			pal(swaps)
		end
		spr(o.s,o.x,o.y)
		pal()
	end
	
	//spr(33,px-4,py-4)
	draw_obj_w_shadow({
		x=px,y=py,s=33
	})
	
	if mode==1 then
		for o in all(objs)do
			draw_obj_w_shadow(o)
		end
	end
	
	--[[
	for s in all(shdw) do
		for y=0,7 do
		for x=0,7 do
			sc=sget(
				(s.s*8)%128+x,
				flr(s.s/16)*8+y
			)
			if sc!=0 then
				apply_shadow(s.x+x,s.y+y)
			end
		
			if(sc==0)goto continue
			wx,wy=s.x+x,s.y+y
			if pget(wx ,wy)==11 then
				pset(wx,wy,3)
			end
			
			::continue::
		//end end
	//end
	]]--
end

function _update()
	if(btn(⬅️))px-=1
	if(btn(➡️))px+=1
	if(btn(⬆️))py-=1
	if(btn(⬇️))py+=1
	
	if(btnp(❎))mode=mode*-1
end
-->8

sb={} // shadow buffer
objs={}
function init_lvl(wi,wj)
	local si,sj=wi+128,wj+128
	
	printh("creating room "..
		wi..","..wj.." ("..
		si..","..sj..")")
	srand((sj<<8)+si)
	
	--1: create shadow buffer
	sb={}
	for j=0,15 do
		sb[j]={}
	for i=0,15 do
		local s=rand(0,1)
		sb[j][i]=s
	end end
	
	lvl={}
	for j=0,15 do
	for i=0,15 do
		add(lvl,{s=1,x=i*8,y=j*8})
	end end
	
	shdw={}
	--[[
	for i=0,100 do
		add(shdw,{
			s=60,
			x=rand(0,15)*8,
			y=rand(0,15)*8
		})
	end
	]]--
	for i=0,100 do
		add(objs,{
			s=17,
			x=rand(0,120),
			y=rand(0,120)
		})
	end
end
-->8
function rand(l,h)
	return flr(rnd(h+1-l))+l
end


swaps={
	//0,//0
	0,//1
	0,//2
	1,//3
	0,//4
	0,//5
	0,//6
	6,//7
	0,//8
	0,//9
	0,//10
	3,//11
	13,//12
	0,//13
	0,//14
	0,//15,
	0 //0 (at the end for some reason)
}

function apply_shadow(wx,wy)
	local c=pget(wx,wy)
	pset(wx,wy,swaps[c+1])
end

--[[
this doesnt work. 

things to try:

1:
	right now this is not consider-
	ing the shadow's offset onto 
	the target object. try modifying
	this to calculate that offset
	when checking the overlap of the
	shadow to the object. prob will
	need modulo
	
--or--

2.
	go back to the old method where
	we just draw the objects first
	and then just draw the shadows
	ontop. to make that more efficient
	try:
		1. create shadows as blobs,
			where 0 is empty, 1 is a full
			shadow, and 2 is an edge.
		2. the tiles that are 1 can paint
			the ground as currently done.
		3. keep a buffer that stores all
			of the edges + any "1" tiles
			that are touching an obj. use
			the pixel method to paint those.
]]--
function draw_obj_w_shadow(o)
	local i=flr(o.x/8)
	local j=flr(o.y/8)
	local dx,dy=o.x-4,o.y-1
	spr(o.s,dx,dy)
	if sb[j][i]==1 then
		//pal(swaps)
		for y=0,7 do
		for x=0,7 do
			oc=sget(
				(o.s*8)%128+x,
				flr(o.s/16)*8+y
			)
			sc=sget(
				(60*8)%128+x,
				flr(61/16)*8+y
			)
			if oc!=0 and sc!=0 then
				apply_shadow(
					dx+x,
					dy+y
				)
			end
		end end
	end
end
__gfx__
00000000bbbbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbb3b3b0007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700bbbbbb3b0007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000bbbbbbbb0777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000bbbbbbbb0777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700b3bbbbbb0007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b3bbbbbb0007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000008800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000078878000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000887888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088887000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007c7c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000077777777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000077770777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777770777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777770777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777000777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000077077070777777770000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000770777777770000000000000000
__map__
0101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101110101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101011101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
