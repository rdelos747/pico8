pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
-- shrimp
acx=0.1
acy=0.1
p_f_max=3

tris_d={
	{
		{0,0},
		{8,8},
		{0,8},
		{0.125} //norm
	}
}

function _init()
	printh("=======start=======")
	pp={x=60,y=60,w=8,h=8}
	pvx,pvy=0,0
	cmi,cmj=0,0
	sols={}
	tris={}
	
	get_tris()
end

function _draw()
	cls(1)
	map(0,0)
	spr(1,pp.x-4,pp.y-4)
	
	for t in all(tris)do
		for i=1,3 do
			pset(t[i][1],t[i][2],7)
		end
	end
end

function _update()
	pvy=min(pvy+acx,p_f_max)
	//pp.y+=pvy
	
	local a=atan2(pvx,pvy)
	//printh(a)
	
	if on_sol(pp,0,0) then
		pp.y=(flr(pp.y/8)*8)+5
		pvy=0
	else 
		for t in all(tris)do
			if pt_in_tri(
				pp.x+cos(a)*6,
				pp.y+sin(a)*6,t) then
				//printh("here")
				//return t
				//pp.x+=cos(t[4])
				//pp.y+=sin(t[4])
				pvx+=cos(t[4])
				pvy+=sin(t[4])
			end
		end
	end
	
	pp.x+=pvx
	pp.y+=pvy
end

function obj(x,y,w,h)
	return {x=x,y=y,w=w,h=h}
end

function get_tris()
	local ii,jj=cmi*16,cmj*16
	for j=jj,jj+15 do
	for i=ii,ii+15 do
		if mget(i,j)==3 then
			//pset(i*8,j*8,7)
			//add(sols,{
			local t={}
			printh(#tris)
			local td=tris_d[1]
			for k=1,3 do
				add(t,{
					i*8+td[k][1],
					j*8+td[k][2]
				})
			end
			t[4]=td[4]
			add(tris,t)
		end
	end end
end

function col_bb(a,b)
	if b.w==0 or b.h==0 then
		return false
	end
	local ax=a.x-a.w/2
	local ay=a.y-a.h/2
	local bx=b.x-b.w/2
	local by=b.y-b.h/2
	
	return ax<=bx+b.w and
		ax+a.w>=bx and ay<=by+b.h and
		ay+a.h>=by
end

function test_w_wrap(a,b)
	local aa=a
	//if scr_wrap then
		aa=obj(
			a.x%128+cmj*8,
			a.y,a.w,a.h)
	//end
	if col_bb(aa,b) then
		return b
	end
	return nil
end

function on_sol(o,ox,oy)
	//if type(lrs)!="table" then
	//	lrs={lrs}
	//end
	//if(hb_mod==nil)hb_mod=0
	
	local a=obj(o.x+ox,o.y+oy,o.w,o.h)
	local mi=flr(a.x/8)
	local mj=flr(a.y/8)
	
	for j=min(cmj+15,mj+1),max(cmj,mj-1),-1 do
	for ii=mi-1,mi+1 do
		local i=ii%16+cmi
		local s=mget(i,j)
		if fget(s,0) then
			//local h=f==1 and 4 or 8
			local b=obj(
				i*8+4,
				j*8+4,
				8,8
			)
			if test_w_wrap(a,b) then
				return b
			end
		end
	end end
	
	return nil
end

function pt_in_tri(x,y,tr)
	local p0x,p0y=tr[1][1],tr[1][2]
	local p1x,p1y=tr[2][1],tr[2][2]
	local p2x,p2y=tr[3][1],tr[3][2]
	
	local dx=x-p2x
	local dy=y-p2y
	local dx21=p2x-p1x
	local dy12=p1y-p2y
	local d=dy12*(p0x-p2x)+dx21*(p0y-p2y)
	local s=dy12*dx+dx21*dy
	local t=(p2y-p0y)*dx+(p0x-p2x)*dy
	if d<0 then
		return s<=0 and t<=0 and s+t>=d
	end
	
	return s>=0 and t>=0 and s+t<=d
end

__gfx__
00000000007777009999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000070000709000000999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700700000079090000990900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000700000079009000990090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000700000079000900990009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700700000079000090990000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000070000709000000990000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777009999999999999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000003000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000030000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000300000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
