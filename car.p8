pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
px,py=0,0
vx,vy=0,0
pts={}
ang=0.25
camx,camy=0,0

gear=1
gears={
	{
		min=0,max=40,acc=0.03
	},
	{
		min=0,max=80,acc=0.02
	},
	{
		min=35,max=120,acc=0.01
	},
	{
		min=100,max=150,acc=0.006
	},
	{
		min=120,max=200,acc=0.004
	}
}
rpm=0 //[0,1]
spd=0
turn=0
grip=0

pts_1={
	{530,-330},
	{530,230},
	{470,230},
	{470,300},
	{430,430},
	{300,460}
}

skids={}

function rot(x,y)
	local a=ang+0.25
	x-=px
	y-=py
	local rx=x*cos(a)-y*sin(a)
	local ry=x*sin(a)+y*cos(a)
	rx+=camx+64
	ry+=camy+115
	return rx,ry
end

function _init()
	printh("=== start ===")
	//add(pts,{-20,-20})
	//add(pts,{20,-20})
	//add(pts,{20,20})
	//add(pts,{-20,20})
	//add(pts,{530,-330})
	
	--[[
	for i=0,100 do
		add(pts,{i*100,20})
		add(pts,{i*100,-20})
	end
	]]--
	
	for p in all(pts_1) do
		add(pts,p)
	end
	
	px=pts[1][1]
	py=pts[1][2]
end

function _draw()
	cls()
	camx=px-64
	camy=py-115
	camera(camx,camy)
	
	--points
	for i=1,#pts do
		local p1=pts[i]
		local p2=pts[(i%#pts)+1]
		local x1,y1=rot(p1[1],p1[2])
		local x2,y2=rot(p2[1],p2[2])
		line(x1,y1,x2,y2,7)
	end
	
	--skids
	for s in all(skids) do
		local x,y=rot(s[1],s[2])
		spr(1,x,y)
	end
	
	-- player
	rect(px-3,py-5,px+3,py+5)
	//rect(px-5,py-5,px-7,py-3)
	
	-- debug
	print("ang:"..ang,camx,camy)
	print("x,y:"..px..","..py,camx,camy+8)
	print("spd:"..spd,camx,camy+16)
	
	-- map
	rect(camx,camy+100,camx+28,camy+127,7)
	mx=((px+50)/1100)*28
	my=((py+50)/1400)*28
	mx2=mx+cos(ang)
	my2=my-sin(ang)
	pset(camx+mx,camy+100+my,7)
	pset(camx+mx2,camy+100+my2,9)
	
	--tach
	circ(camx+116,camy+122,10,7)
	local a=rpm*0.8+0.3
	line(camx+116,camy+122,
		camx+116+cos(a)*5,
		camy+122+sin(-a)*5,
		7)
	print(gear,camx+115,camy+106,7)

	--turn
	rect(camx+54,camy+122,camx+74,camy+127)
	rectfill(camx+64,camy+123,
		camx+64+flr(turn*10),camy+126,8)
	line(camx+64,camy+125,
		camx+64+10*grip,camy+125,11)
	line(camx+64,camy+125,
		camx+64-9*grip,camy+125,11)		
end

function _update()
	local last_g=gear
	if(btnp(‚ùé))gear=min(5,gear+1)
	if(btnp(üÖæÔ∏è))gear=max(1,gear-1)
	
	local g=gears[gear]
	
	rpm=(spd-g.min)/(g.max-g.min)
	if rpm > 1 then
		printh("bad downshift")
		rpm=1
	elseif rpm < 0 then
		printh("bad upshift")
		rpm=0
	end
	
	if btn(‚¨áÔ∏è) then
		// breaking
		spd=max(0,spd-2)
		printh("breaking")
	else
		if btn(‚¨ÜÔ∏è) then
			rpm=min(1,rpm+g.acc)
		else
			rpm=max(0,rpm-g.acc)
			//spd=max(0,spd-0.01)
		end
	end
	
	if spd>=g.min then
		spd=(g.max-g.min)*rpm+g.min
	end
	
	if btn(‚¨ÖÔ∏è) then
		turn=max(-1,turn-0.1)
	elseif btn(‚û°Ô∏è) then
		turn=min(1,turn+0.1)
	elseif turn<0 then
		turn=min(0,turn+0.05)
	elseif turn>0 then
		turn=max(0,turn-0.05)
	end
	
	local fx=cos(ang)*spd/60
	local fy=sin(ang)*spd/60
	
	local dx,dy=0,0
	grip=1-((spd-80)/300)
	//printh(grip)
	local slip=abs(turn)-grip
	// printh(slip)
	if slip>0 then
		spd=max(0,spd-0.1)
		dx=cos(ang-0.5*sgn(turn))*slip*spd/60
		dy=sin(ang-0.5*sgn(turn))*slip*spd/60
		printh(slip.." "..dx.." "..dy)
		add(skids,{px,py})
		ang=(ang+turn*0.001)%1
	elseif spd>0 then
		ang=(ang+turn*0.01)%1
	end
	
	vx=fx+dx
	vy=fy+dy
	
	px+=vx
	py-=vy
	
	
	local off=flr(rpm*23)*5
	sfx(flr(off/30),0,off%30)
	sfx(flr(off/30)+5,1,off%30)
end
__gfx__
00000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
450100000025000250002500025000250012500125001250012500125002250022500225002250022500325003250032500325003250042500425004250042500425005250052500525005250052500000000000
4501000006250062500625006250062500725007250072500725007250082500825008250082500825009250092500925009250092500a2500a2500a2500a2500a2500b2500b2500b2500b2500b2500000000000
450100000c2500c2500c2500c2500c2500d2500d2500d2500d2500d2500e2500e2500e2500e2500e2500f2500f2500f2500f2500f250102501025010250102501025011250112501125011250112500000000000
450100001225012250122501225012250132501325013250132501325014250142501425014250142501525015250152501525015250162501625016250162501625017250172501725017250172500020000200
010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d70100000015000150001500015000150011500115001150011500115002150021500215002150021500315003150031500315003150041500415004150041500415005150051500515005150051500010000100
d701000006150061500615006150061500715007150071500715007150081500815008150081500815009150091500915009150091500a1500a1500a1500a1500a1500b1500b1500b1500b1500b1500010000100
d70100000c1500c1500c1500c1500c1500d1500d1500d1500d1500d1500e1500e1500e1500e1500e1500f1500f1500f1500f1500f150101501015010150101501015011150111501115011150111500010000100
d70100001215012150121501215012150131501315013150131501315014150141501415014150141502115015150151501515015150161501615016150161501615017150171501715017150171500010000100
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000000000000000000000000000
010100000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100001000010000100000000000000000000000000000000
010a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
