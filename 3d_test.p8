pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
sdist=100 --screen dist for 3d projection, measured in pixels
--maxz=0 --tells us how much ceiling/floor need to be drawn

cam={1.5,1.5}
ang=0.5 --player angle?

zbuf={}
colsx,colsy={},{}
ix,iy=0,0 --input axes?

function _init()
	printh("========")
	printh("game start")
	init_game()
end

function _draw()
	maxz=0
	draw_walls()
	draw_ceil_flr()
	draw_cols()
	//print("ang"..ang)
	//print("ix"..ix)
	//print("iy"..iy)
end

-- function _update60() ?
function _update60()
	update_input()
	update_game()
end
-->8
-- drawing

function draw_walls()
	palt(0,false) // ?

	local sa=sin(ang)
	local ca=cos(ang)
	
	--raycast map
	for i=0,127 do
		--ray dir
		local dx,dy=64-i,sdist
		
		--rotate by cam ang
		dx=ca*dx+sa*dy
		dy=ca*dy-sa*dx
		
		--tweak ray to avoid div by 0
		if(abs(dx)<0.001)dx=0.001
		if(abs(dy)<0.001)dy=0.001
		
		--horz traversal
		local hx,hy=cam[1],cam[2]
		local hdx=sgn(dx)
		local hdy=dy/abs(dx)
		local hdz=hdx*sa+hdy*ca
		local hz=0
		
		--move to next horz boundry
		local hstep=hx-flr(hx)
		if(hdx>0)hstep=(1-hstep)
		hx+=hdx*hstep
		hy+=hdy*hstep
		hz+=hdz*hstep
		
		--vert traversal
		local vx,vy=cam[1],cam[2]
		local vdx=dx/abs(dy)
		local vdy=sgn(dy)
		local vdz=vdx*sa+vdy*ca
		local vz=0
		
		--move to next vert boundry
		local vstep=vy-flr(vy)
		if(vdy>0)vstep=(1-vstep)
		vx+=vdx*vstep
		vy+=vdy*vstep
		vz+=vdz*vstep
		
		::searchloop::
		
		--is next boundary horz or vert?
		if hz<vz then
			--hit solid cell?
			local m=mget(hx+hdx*0.5,hy)
			if m>=48 then
				draw_col(m,hy-flr(hy),hz,i)
				goto raydone
			end
			
			--advance to next horz boundary
			hx+=hdx
			hy+=hdy
			hz+=hdz
		else
			--hit solid cell?
			local m=mget(vx,vy+vdy*0.5)
			if m>=48 then
				draw_col(m,vx-flr(vx),vz,i)
				goto raydone
			end
			
			--advance to next vert boundary
			vx+=vdx
			vy+=vdy
			vz+=vdz
			
		end
		goto searchloop
		::raydone::
	end
end

--checked
function draw_col(m,tx,z,x)
	--draw wall column
	--m = map value
	--tx = "texture" x coord (0,1)
	--z = z dist
	--x = screen x
	
	m-=48
	local sx=((m%4)+tx)*32
	local sy=flr(m/4)*32+32
	colsx[x+1]=sx
	colsy[x+1]=sy
	zbuf[x+1]=z
	maxz=max(maxz,z)
end

--checked
function draw_cols()
	for x=0,127 do
		local h=sdist/zbuf[x+1]
		local y0=ceil(64-h/2)
		local y1=ceil(64+h/2)
		sspr(colsx[x+1],colsy[x+1],
			1,32,x,y0,1,y1-y0)
	end
end

function draw_ceil_flr()
	palt(0,false) // ?
	local h=sdist/maxz // how not divide by 0??
	// printh(h)
	
	-- darw ceiling
	
	-- following pokes set
	-- tline w,h,x,y to sample
	-- from map
	poke(0x5f38,4) 
	poke(0x5f39,4)
	poke(0x5f3a,124)
	poke(0x5f3b,4)
	for y=-64,-ceil(h/2) do
		draw_row(y,0.5)
	end
	
	-- draw floor
	poke(0x5f38,4) 
	poke(0x5f39,4)
	poke(0x5f3a,124)
	poke(0x5f3b,0)
	for y=ceil(h/2),63 do
		draw_row(y,0.25)
	end
end

function draw_row(y,tilesize)
	local sa=sin(ang)
	local ca=cos(ang)
	
	-- gradient of floor ray
	local g=abs(y)/sdist
	
	-- z distance to intersection
	local z=0.5/g
	
	-- map coords for center of floor
	local mx=(cam[1]+z*sa)/tilesize
	local my=(cam[2]+z*ca)/tilesize

	--scale
	local s=sdist/z*tilesize
	local mdx=-ca/s
	local mdy=sa/s
	
	-- move left 64 px ?? why
	mx-=64*mdx
	my-=64*mdy
	
	-- draw line
	tline(0,y+64,128,y+64,mx,my,mdx,mdy)
end
-->8
--update

function update_input()
 local x,y=0,0
 if(btn(⬅️))x-=1
 if(btn(➡️))x+=1
 if(btn(⬆️))y-=1
 if(btn(⬇️))y+=1
 ix=ix*0.875+x*0.125
 iy=iy*0.9+y*0.1
end

function update_game()
	local v={
		sin(ang)*-iy*0.04,
		cos(ang)*-iy*0.04
	}
	ang+=ix*0.0075
	cam[1]+=v[1]
	cam[2]+=v[2]
end

function is_col(p,r)
	
end
-->8
-- init

function init_game()
	-- scan map for objs
	-- populate obj array
	-- detect cam start pt
	for y=0,31 do		--map bounds
	for x=0,127 do --map bounds
		local m=mget(x,y)
	end end	
	
	for i=1,128 do
		add(zbuf,0)
		add(colsx,0)
		add(colsy,0)
	end
end
__gfx__
0000000088888888dddddddd45454545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000080000008d000000d54545454000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070080099008d0bbb00d45454545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700080900008d0b0000d54545454000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700080900008d0bb000d45454545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070080099008d0b0000d54545454000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000080000008d000000d45454545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000088888888dddddddd54545454000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020200c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c002020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000cc000000cc000000cc000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020cc020020cc020020cc020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020cc020020cc020020cc020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020200cc020200cc020200cc020200c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c002020cc002020cc002020cc002020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000cc000000cc000000cc000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccc0000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000c0000000000000000c000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020c0000000000000000c020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020c0000000000000000c020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020200c0000000000000000c020200c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c002020c0000000000000000c002020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000c0000000000000000c000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccc0000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccc0000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000c0000000000000000c000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020c0000000000000000c020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020c0000000000000000c020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020200c0000000000000000c020200c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c002020c0000000000000000c002020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000c0000000000000000c000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccc0000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000cc000000cc000000cc000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020cc020020cc020020cc020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020020cc020020cc020020cc020020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c020200cc020200cc020200cc020200c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c002020cc002020cc002020cc002020c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000000cc000000cc000000cc000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
3030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003030303
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003030303
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003030303
3000003030000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003030303
3000003030000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001300130
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030013001
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001300130
3030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030013001
