pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
--globals/config
sdist=100 -- screen for 3d proj, dist in px
sheight=100 --view height in px

cam={1.5,1.5}
ang=0.5
needredraw=true

zbuf={}
tbuf={}
ix,iy=0,0

function __init()
	printh("=======")
	printh("start")
	
	for i=1,128 do
		add(zbuf,0)
		add(tbuf,0)
	end
end

-->8
--draw

function __draw()
	// setfog(0)
	if needredraw then
		if sheight<128 then
			cls()
			sspr(40,0,8,8,0,sheight,128,8)
		end
		needredraw=false
	end
	
	draw3dview()
	camera()
	pal()
end

function draw3dview()
	camera(0,(128-sheight)/2)
	clip(0,0,128,sheight)
	
	raycastwalls()
	
	drawceilflr()
end

function raycastwalls()
	maxz=0
	minx,miny=cam[1],cam[2]
	maxx,maxy=minx,miny
	
	local sa=sin(ang)
	local ca=cos(ang)
	
	for i=0,127 do
		local dx,dy=64-i,sdist
		
		dx=ca*dx+sa*dy
		dy=ca*dy-sa*dx
		
		if(abs(dx)<0.001)dx=0.001
  if(abs(dy)<0.001)dy=0.001
  
  local hx,hy=cam[1],cam[2]
  local hdx=sgn(dx)
  local hdy=dy/abs(dx)
  local hdz=hdx*sa+hdy*ca
  local hz=0
  
  local hstep=hx%1
  if(hdx>0)hstep=(1-hstep)
  hx+=hdx*hstep
  hy+=hdy*hstep
  hz+=hdz*hstep
  if(hdx<0)hx-=1
  
  local vx,vy=cam[1],cam[2]
  local vdx=dx/abs(dy)
  local vdy=sgn(dy)
  local vz=0
  
  local vstep=vy%1
  if(vdy>0)vstep=(1-vstep)
  vx+=vdx*vstep
  vy+=vdy*vstep
  vz+=vdz*vstep
  if(vdy<0)vy-=1
  
::searchloop::
		if hz<vz then
			local m=
		end
	end
end

function drawceilflr()
end
-->8
--update

function __update()
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
80000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
80800808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
80800808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
80808008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
80080808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
80000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888999999998888888899999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999888888889999999988888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
3030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
